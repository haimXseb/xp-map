{
  "meta": {
    "name": "OZ – Design-Time Accessibility Assistant",
    "updated": "2025-12-30",
    "mvp": "Text Field – E2E",
    "repo": "github.com/1haim/figma-oz"
  },
  "executionLog": {
    "metadata": {
      "version": "1.0",
      "lastUpdated": "2025-12-30T01:00:00Z",
      "currentPhase": "phase4",
      "currentGoal": "Wiring - Fixing engine wired: Rules connected to orchestrator, Plan View implemented, Autofix triggered from UI"
    },
    "blockers": [],
    "phases": [
      {
        "id": "phase2",
        "name": "Ops & Visibility",
        "epics": [
          {
            "id": "execution-log",
            "name": "EXECUTION_LOG.json",
            "status": "done",
            "owner": "Cursor",
            "evidence": "docs/EXECUTION_LOG.json",
            "tasks": []
          },
          {
            "id": "ui-map",
            "name": "UI-Map.md",
            "status": "done",
            "owner": "Cursor",
            "evidence": "docs/UI-Map.md",
            "tasks": []
          },
          {
            "id": "context-dump",
            "name": "context-dump.mjs",
            "status": "done",
            "owner": "Cursor",
            "evidence": "scripts/context-dump.mjs, CONTEXT_DUMP.txt",
            "tasks": [
              {
                "id": "context-dump-script",
                "name": "Create context-dump.mjs script",
                "status": "done",
                "owner": "Cursor",
                "evidence": "scripts/context-dump.mjs"
              }
            ]
          },
          {
            "id": "xp-protocol",
            "name": "XP Protocol (generate-xp-status.mjs)",
            "status": "done",
            "owner": "Cursor",
            "evidence": "scripts/generate-xp-status.mjs, xp-data.json",
            "tasks": [
              {
                "id": "xp-status-script",
                "name": "Create generate-xp-status.mjs",
                "status": "done",
                "owner": "Cursor",
                "evidence": "scripts/generate-xp-status.mjs"
              }
            ]
          },
          {
            "id": "product-journey-map",
            "name": "Product Journey Map",
            "status": "done",
            "owner": "Cursor",
            "evidence": "docs/Product-Journey-Map.md",
            "tasks": [
              {
                "id": "journey-map-doc",
                "name": "Create Product-Journey-Map.md with Block System analysis",
                "status": "done",
                "owner": "Cursor",
                "evidence": "docs/Product-Journey-Map.md"
              }
            ]
          },
          {
            "id": "dashboard",
            "name": "Project Dashboard",
            "status": "in-progress",
            "owner": "Cursor",
            "evidence": "dashboard/index.html",
            "tasks": [
              {
                "id": "dashboard-react",
                "name": "React Dashboard Setup",
                "status": "done",
                "owner": "Cursor",
                "evidence": "dashboard/src/App_FULL.tsx"
              },
              {
                "id": "dashboard-home-tab",
                "name": "Home Tab with Master Plan",
                "status": "in-progress",
                "owner": "Cursor",
                "evidence": "dashboard/src/App.tsx"
              }
            ]
          }
        ]
      },
      {
        "id": "phase3",
        "name": "Rules",
        "epics": [
          {
            "id": "text-field-rules",
            "name": "Text Field Rules (TF-01..TF-14)",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/rules/textField.ts, src/rules/utils.ts",
            "tasks": [
              {
                "id": "rules-foundation",
                "name": "Create src/rules/utils.ts with WCAG math",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/rules/utils.ts"
              },
              {
                "id": "text-field-checks",
                "name": "Implement TF-01 through TF-14 checks",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/rules/textField.ts"
              }
            ]
          },
          {
            "id": "button-rules",
            "name": "Button Rules (BL-01..BL-05)",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/rules/button.ts",
            "tasks": [
              {
                "id": "button-checks",
                "name": "Implement BL-01 through BL-05 checks",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/rules/button.ts"
              }
            ]
          },
          {
            "id": "checkbox-rules",
            "name": "Checkbox Rules (CB-01..CB-03)",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/rules/checkbox.ts",
            "tasks": [
              {
                "id": "checkbox-checks",
                "name": "Implement CB-01 through CB-03 checks",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/rules/checkbox.ts"
              }
            ]
          },
          {
            "id": "select-rules",
            "name": "Select/Dropdown Rules (SC-01..SC-03)",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/rules/dropdown.ts",
            "tasks": [
              {
                "id": "dropdown-checks",
                "name": "Implement SC-01 through SC-03 checks",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/rules/dropdown.ts"
              }
            ]
          }
        ]
      },
      {
        "id": "phase4",
        "name": "Wiring",
        "epics": [
          {
            "id": "code-wiring",
            "name": "code.ts wiring",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/code.ts",
            "tasks": [
              {
                "id": "orchestrator",
                "name": "Multi-component orchestrator",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/code.ts:classifyComponent"
              },
              {
                "id": "vision-integration",
                "name": "AI Vision integration",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/code.ts:classifyFromImageVision"
              },
              {
                "id": "rule-hooks",
                "name": "Rule hooks into orchestrator",
                "status": "done",
                "owner": "Cursor",
                "evidence": "src/code.ts - rule checks integrated in classifyComponent"
              }
            ]
          },
          {
            "id": "schema-conformance",
            "name": "schema conformance",
            "status": "done",
            "owner": "Cursor",
            "evidence": "src/code.ts - rule results merged into reasoning array",
            "tasks": []
          }
        ]
      }
    ],
    "logEntries": [
      {
        "timestamp": "2025-12-30T01:00:00Z",
        "type": "task_completed",
        "message": "Wired fixing engine: Connected rules to orchestrator (checks array returned), implemented Plan View in UI (accessibility issues, autofix toggles, dev handoff), wired 'Apply Selected Fixes' button to trigger handleAutofix. Plugin now runs checks automatically and displays actionable plan.",
        "phase": "phase4",
        "files": [
          "src/code.ts",
          "ui/ui.html"
        ]
      },
      {
        "timestamp": "2025-12-29T23:50:00Z",
        "type": "task_completed",
        "message": "Completed full engine wiring and rule implementation for MVP components. All Phase 3 rules (TF-01..TF-14, BL-01..BL-05, CB-01..CB-03, SC-01..SC-03) implemented and wired into Phase 4 orchestrator. Handoff UI state completed.",
        "phase": "phase4",
        "files": [
          "src/rules/textField.ts",
          "src/rules/button.ts",
          "src/rules/checkbox.ts",
          "src/rules/dropdown.ts",
          "src/code.ts",
          "ui/ui.html"
        ]
      },
      {
        "timestamp": "2025-12-29T23:45:00Z",
        "type": "bugfix",
        "message": "Fixed Classification Engine bias (everything identified as Button) and UI runtime crash (detailsList). Adjusted button detector weights, added penalties for textField signals, fixed detailsList scope issue in UI.",
        "phase": "phase4",
        "files": [
          "src/code.ts",
          "ui/ui.html"
        ]
      },
      {
        "timestamp": "2025-12-28T12:40:00Z",
        "type": "task_completed",
        "message": "Phase 4 Batch 4.1 & 4.2: Integrated rule checks into classifyComponent orchestrator",
        "phase": "phase4",
        "files": [
          "src/code.ts"
        ]
      },
      {
        "timestamp": "2025-12-28T12:35:00Z",
        "type": "task_completed",
        "message": "Phase 3 Batch 3.3 & 3.4: Created src/rules/button.ts, checkbox.ts, and dropdown.ts with all remaining rules",
        "phase": "phase3",
        "files": [
          "src/rules/button.ts",
          "src/rules/checkbox.ts",
          "src/rules/dropdown.ts"
        ]
      },
      {
        "timestamp": "2025-12-28T12:30:00Z",
        "type": "task_completed",
        "message": "Phase 3 Batch 3.1 & 3.2: Created src/rules/utils.ts and src/rules/textField.ts with TF-01..TF-14 checks",
        "phase": "phase3",
        "files": [
          "src/rules/utils.ts",
          "src/rules/textField.ts"
        ]
      },
      {
        "timestamp": "2025-12-28T12:25:00Z",
        "type": "task_completed",
        "message": "Batch 2.3: Created Product-Journey-Map.md with Block System analysis",
        "phase": "phase2",
        "files": [
          "docs/Product-Journey-Map.md"
        ]
      },
      {
        "timestamp": "2025-12-28T12:22:00Z",
        "type": "task_completed",
        "message": "Batch 2.1 & 2.2: Created context-dump.mjs and generate-xp-status.mjs",
        "phase": "phase2",
        "files": [
          "scripts/context-dump.mjs",
          "scripts/generate-xp-status.mjs",
          "CONTEXT_DUMP.txt",
          "xp-data.json"
        ]
      },
      {
        "timestamp": "2025-12-28T10:30:00Z",
        "type": "task_completed",
        "message": "Created EXECUTION_LOG.json structure",
        "phase": "phase2",
        "files": [
          "docs/EXECUTION_LOG.json"
        ]
      },
      {
        "timestamp": "2025-12-25T14:00:00Z",
        "type": "task_completed",
        "message": "Component detection engine with multi-signal scoring",
        "phase": "phase4",
        "files": [
          "src/code.ts"
        ]
      },
      {
        "timestamp": "2025-12-24T09:00:00Z",
        "type": "task_completed",
        "message": "Preview export + PREVIEW_READY protocol message",
        "phase": "phase4",
        "files": [
          "src/code.ts",
          "ui/ui.html"
        ]
      },
      {
        "timestamp": "2025-12-23T16:00:00Z",
        "type": "task_completed",
        "message": "verify-changelog script + commit gating",
        "phase": "phase2",
        "files": [
          "scripts/verify-changelog.cjs"
        ]
      }
    ],
    "reasoning": [
      {
        "timestamp": "2025-12-28T10:30:00Z",
        "action": "Created EXECUTION_LOG.json",
        "why": "Need single source of truth for task status, decisions, and blockers. Enables dashboard to show real-time project state.",
        "relatedFiles": [
          "docs/EXECUTION_LOG.json"
        ],
        "phase": "phase2"
      },
      {
        "timestamp": "2025-12-25T14:00:00Z",
        "action": "Implemented multi-signal component detection",
        "why": "Need reliable component type identification using structure, layout, and semantic signals. Strict gate (0.85 confidence + 0.35 structural) ensures quality.",
        "relatedFiles": [
          "src/code.ts"
        ],
        "phase": "phase4"
      }
    ]
  },
  "gitStatus": {
    "branch": "main",
    "workingTree": "dirty",
    "modifiedFiles": [
      ".tmp-xp-map",
      "CONTEXT_DUMP.txt",
      "FILES_TREE.md",
      "PROJECT_TREE.md",
      "dashboard-sync/dashboard-sync.json",
      "dashboard/data.json",
      "docs/CURRENT_STATUS.md",
      "docs/EXECUTION_LOG.json",
      "docs/GIT_STATUS.json",
      "docs/archive/deliverable-3-full-component-specifications-logic.docx",
      "docs/mvp-rule-pack-LOCKED-local.docx",
      "docs/mvp-rule-pack-LOCKED-local.docx.backup",
      "docs/mvp-rule-pack-LOCKED.docx",
      "package.json",
      "src/code.ts",
      "src/ui-inline.ts",
      "ui/ui.html",
      "xp-data.json",
      ".tmp.driveupload/",
      "FULL_CODEBASE.txt",
      "Users/",
      "docs/mvp-rule-pack-LOCKED.docx.backup",
      "dump_project.py"
    ],
    "ahead": 0,
    "behind": 0,
    "lastCommit": "2025-12-29 00:37:38 +0200",
    "lastPush": "2025-12-29 00:37:38 +0200",
    "timestamp": "2025-12-30T01:26:21.168Z"
  },
  "progress": {
    "masterPlan": {
      "total": 3,
      "completed": 0,
      "percentage": 0
    },
    "rules": {
      "total": 26,
      "implemented": 25,
      "percentage": 0.9615384615384616
    }
  },
  "recent": [
    {
      "date": "2025-12-25",
      "items": [
        "Component detection engine with multi-signal scoring (structure + layout + semantic), strict gate (confidence >= 0.85 AND structural >= 0.35), auto-resolve parent tree climbing (up to 3 levels)"
      ]
    },
    {
      "date": "2025-12-24",
      "items": [
        "Preview export (natural size, transparent background) + PREVIEW_READY protocol message"
      ]
    },
    {
      "date": "2025-12-23",
      "items": [
        "Added `scripts/verify-changelog.cjs` and npm scripts to gate commits on CHANGELOG updates when code changes."
      ]
    },
    {
      "date": "2025-12-23",
      "items": [
        "Quarantined legacy sources (`src/accessibility.ts`, `src/tool-library.ts`) to `quarantine/legacy-2025-12-23/` since the runtime now uses inlined equivalents."
      ]
    },
    {
      "date": "2025-12-23",
      "items": [
        "Removed stray `.DS_Store` files and ignored them via `.gitignore`."
      ]
    },
    {
      "date": "2025-12-23",
      "items": [
        "Documented the current architecture and entry points in `ARCHITECTURE.md`."
      ]
    }
  ],
  "uiMap": "# UI State Machine\n\n**Last Updated**: 2025-12-28  \n**Purpose**: Document UI state machine and transitions\n\n---\n\n## States\n\n### IDLE\n- **Description**: No selection, empty state\n- **UI**: Empty preview area (no placeholder text or box)\n- **Actions**: User selects a node in Figma\n\n### IDENTIFYING\n- **Description**: Scanning/vision classification in progress\n- **UI**: Shows \"AI scanning selection...\" or \"Detecting component type...\"\n- **Actions**: Auto-transitions based on classification result\n\n### NEEDS_CONFIRMATION\n- **Description**: Classification confidence below gate (0.90), requires user confirmation\n- **UI**: Shows chips (sorted by confidence) + manual input + \"Start over\"\n- **Actions**: User selects component type or enters custom name\n\n### IDENTIFIED\n- **Description**: Component type confirmed (either auto-passed or user-selected)\n- **UI**: Shows component type chip, \"Correct\" button, intent display\n- **Actions**: User can click \"Correct\" to change type, or proceed to scan\n\n### PLAN_READY\n- **Description**: Scan complete, plan shown with Designer Changes + Developer Handoff\n- **UI**: Shows \"Designer Changes\" and \"Developer Handoff\" sections, \"Accessible it\" button\n- **Actions**: User can review plan, apply fixes, or export handoff\n\n### EXECUTING\n- **Description**: Applying autofixes in progress\n- **UI**: Shows progress indicator\n- **Actions**: Auto-transitions to DONE when complete\n\n### DONE\n- **Description**: All fixes applied, handoff ready\n- **UI**: Shows completion message, export options\n- **Actions**: User can export handoff or start over\n\n---\n\n## Transitions\n\n```\nIDLE → IDENTIFYING\n  Trigger: User selects node + clicks \"Accessible it\"\n  \nIDENTIFYING → NEEDS_CONFIRMATION\n  Trigger: Classification confidence < 0.90 OR gate fails\n  \nIDENTIFYING → IDENTIFIED\n  Trigger: Classification confidence >= 0.90 AND gate passes\n  \nNEEDS_CONFIRMATION → IDENTIFIED\n  Trigger: User selects component type (chip or manual input)\n  \nIDENTIFIED → PLAN_READY\n  Trigger: Scan complete, plan generated\n  \nPLAN_READY → EXECUTING\n  Trigger: User clicks \"Accessible it\" (apply fixes)\n  \nEXECUTING → DONE\n  Trigger: All fixes applied\n  \nAny state → IDLE\n  Trigger: Selection cleared (nodes = 0)\n```\n\n---\n\n## State Variables\n\n### selectionState\n- `none`: No selection\n- `hasSelection`: Node selected\n\n### classifyState\n- `idle`: Not classifying\n- `processing`: Classification in progress\n- `done`: Classification complete\n\n### certaintyState\n- `certain`: Confidence >= 0.90, gate passed\n- `uncertain`: Confidence < 0.90 or gate failed\n\n### reasoningState\n- `collapsed`: Reasoning panel hidden\n- `expanded`: Reasoning panel visible\n\n---\n\n## UI Components by State\n\n### IDLE\n- Empty preview area (no placeholder UI)\n- No preview image\n- No actions\n\n### IDENTIFYING\n- Preview (immutable, from selection)\n- Status text: \"AI scanning selection...\"\n- Loading indicator (optional)\n\n### NEEDS_CONFIRMATION\n- Preview (immutable)\n- Component type chips (sorted by confidence)\n- Manual input field\n- \"Start over\" button\n\n### IDENTIFIED\n- Preview (immutable, from selection only)\n- Component type chip\n- \"Correct\" button\n- Intent display\n- \"Show Reasoning\" toggle\n- \"Accessible it\" button (only after classification confirmed)\n\n### PLAN_READY\n- Preview (collapsed to header thumbnail)\n- \"Designer Changes\" section\n- \"Developer Handoff\" section\n- \"Accessible it\" button\n\n### EXECUTING\n- Progress indicator\n- Status text: \"Applying fixes...\"\n\n### DONE\n- Completion message\n- Export options\n- \"Start over\" button\n\n---\n\n## Notes\n\n- **Preview Immutability**: Preview image only changes when selection changes, not when classification certainty changes\n- **Single UI Shell**: All states use the same layout structure. Uncertainty adds suggestions section, doesn't replace entire UI\n- **State Reset**: When selection cleared, all states reset to IDLE, preview cleared\n- **No Placeholder UI**: Empty state shows empty preview area, no \"Select a node\" message or gray box\n- **One Accessible it Button**: Only one \"Accessible it\" button exists, shown only after classification confirmed\n- **No Annotate Button**: Annotate functionality removed per Figma design\n- **Layer Icons**: Node type icons loaded from `src/assets/layers icons/` based on Figma node type\n- **Data Attributes**: `data-node-id` exists only as HTML attributes, never as visible text\n\n",
  "projectPlan": "# NotebookLM Onboarding - Design-Time Accessibility Plugin\n\n**Purpose**: This document serves as the single onboarding source for NotebookLM (\"Noty\") to understand and navigate the Figma Design-Time Accessibility Plugin project.\n\n**Last Updated**: 2024-12-19  \n**Source of Truth**: `docs/02-project/Project-plan.md` (master plan)\n\n---\n\n## 1. Project in One Page\n\n### Goal\nBuild a Figma plugin that identifies components during design-time, runs accessibility checks, suggests safe fixes, and generates developer handoff. **Shift-left accessibility** - catch issues before code is written.\n\n### MVP Scope\n**Components**: Text Field, Button, Checkbox, Dropdown/Select only  \n**Severity**: WARN only (no FAIL/BLOCKER)  \n**Output**: Design guidance + UX patterns + Code snippets (HTML/ARIA)\n\n### Core Principle\n**AI Visual First (default)**: Vision classification is the primary method. Local tree-based analysis is fallback when AI unavailable or uncertain.\n\n### Locked Decisions\n- **AI Visual First**: Vision default, signals backup\n- **Confidence Gate**: 0.90 threshold for PASS (strict)\n- **Severity Policy**: PASS/ASK/WARN only (no FAIL)\n- **UI Shell**: Static layout, uncertainty adds suggestions only (no layout change)\n- **Output Schema**: Unified JSON contract for classifier/orchestrator\n\n---\n\n## 2. Current Status Snapshot\n\n### What's Implemented\n\n#### UI (`ui/ui.html`)\n- ✅ **Single UI Shell**: State machine with `selectionState`, `classifyState`, `certaintyState`, `reasoningState`\n- ✅ **Header Row**: Node icon, name, preview thumbnail\n- ✅ **Identification Card**: Component type chip, \"Correct\" button, intent display\n- ✅ **Reasoning Panel**: Collapsible, shows \"Why {componentType}\" and \"Why Intent\"\n- ✅ **Correction Flow**: Chips (sorted by confidence) + manual input + \"Start over\"\n- ✅ **Preview**: Natural size export, zoom (100-500%), panning, theme toggle (preview bg only)\n- ✅ **Asset Loading**: All icons embedded as inline SVG\n- ✅ **State Reset**: Clears preview when no selection\n\n#### Engine (`src/code.ts`)\n- ✅ **Multi-Component Orchestrator**: `classifyComponent()` runs detectors for TextField, Button, Checkbox, Dropdown\n- ✅ **AI Vision Integration**: `classifyFromImageVision()` using OpenAI GPT-4o (if API key provided)\n- ✅ **Local Classifiers**: Tree-based detectors with structure/layout/semantic scoring\n- ✅ **Design System Context**: `detectDesignSystemContext()` reads file/page names, applies bias rules\n- ✅ **Hard-Gating**: DS context excludes incompatible component types (e.g., checkbox on \"buttons\" page)\n- ✅ **Auto-Resolve**: Climbs parent tree (up to 3 levels) if initial classification fails\n- ✅ **Decision Fusion**: AI Vision (if `confidence >= 0.80`) else local classifier\n- ✅ **Confidence Gate**: 0.90 threshold for PASS (strict)\n- ✅ **Session Persistence**: Stores chosen component type per nodeId\n\n#### Routing (`src/protocol.ts`)\n- ✅ **Message Types**: `VISION_CLASSIFY_REQUEST`, `VISION_CLASSIFY_RESULT`, `CLASSIFICATION_UPDATED`\n- ✅ **Schema**: `VisionClassifyResultMessage` with `componentType`, `componentTypeConfidence`, `intent`, `intentConfidence`, `reasoning[]`, `gate`, `method`\n- ✅ **User Actions**: `USER_SET_COMPONENT_TYPE`, `USER_SET_COMPONENT_NAME`, `USER_RESTART`\n\n### What's NOT Implemented (MVP Gaps)\n\n#### Missing Features\n- ❌ **Scan Rules**: TF-01..TF-14 checks not implemented (placeholder only)\n- ❌ **Autofix Engine**: Safe autofix (layer renaming, focus states, annotations) not implemented\n- ❌ **Handoff Generator**: Design/UX/Code output not implemented\n- ❌ **ASK Flow Full**: Partial (component type confirmation works, but scan-level ASK not implemented)\n\n#### Known Limitations\n- AI Vision requires OpenAI API key in `figma.clientStorage` (falls back to local if missing)\n- Checkbox and Dropdown detectors are basic (need refinement)\n- No streaming scan results (all-at-once only)\n\n---\n\n## 3. Architecture Map\n\n### Folder Structure\n\n```\nFigma plugin/\n├── src/\n│   ├── code.ts              # Main thread (Figma API, classification, message handling)\n│   ├── protocol.ts          # Message types and guards (UI ↔ Main contract)\n│   └── assets/\n│       ├── ui/              # UI icons (logo, buttons, chevron, etc.)\n│       └── layers icons/    # Figma node type icons (frame, component, text, etc.)\n├── ui/\n│   └── ui.html              # UI thread (HTML/CSS/JS, state machine, rendering)\n├── dist/                    # Build output (generated)\n│   ├── src/code.js          # Compiled main thread\n│   ├── ui.html              # Inline HTML (via build-ui.cjs)\n│   └── assets/              # Copied assets\n├── docs/\n│   ├── 01-foundations/      # Source of truth: foundations-engine-logic.docx\n│   ├── 02-project/         # Project plan, test scenarios, this doc\n│   ├── 03-components/      # Source of truth: mvp-rule-pack.docx\n│   └── 04-research/         # Supporting docs (classifier research, runtime catalog)\n└── scripts/\n    └── build-ui.cjs         # Build script (copies ui.html, generates ui-inline.ts)\n```\n\n### Entry Points\n\n- **Main Thread**: `src/code.ts` → compiled to `dist/src/code.js` (loaded by Figma)\n- **UI Thread**: `ui/ui.html` → copied to `dist/ui.html` (loaded by `figma.showUI()`)\n- **Build**: `npm run build` → runs `build-ui` + `build-main` + `typecheck`\n\n### Runtime Flow\n\n```\n1. User selects node in Figma\n   ↓\n2. Main thread: handleSelectionChange()\n   → Export PNG preview (natural size, transparent)\n   → Send SELECTION_PREVIEW_READY to UI\n   ↓\n3. UI: renderShell() updates preview, shows identification card\n   ↓\n4. User clicks \"Accessible it\"\n   ↓\n5. UI: sends ACCESSIBLE_IT_RUN\n   ↓\n6. Main: handleAccessibilityRun()\n   → Export preview (if not already)\n   → Send PREVIEW_READY\n   ↓\n7. UI: sends VISION_CLASSIFY_REQUEST\n   ↓\n8. Main: handleVisionClassify()\n   → detectDesignSystemContext()\n   → classifyFromImageVision() [if ENABLE_AI_VISION && API key]\n   → classifyComponent() [orchestrator: runs all detectors]\n   → Decision fusion (AI vs local)\n   → Auto-resolve (if FAIL, climb parent tree)\n   → Send VISION_CLASSIFY_RESULT\n   ↓\n9. UI: handleVisionClassifyResult()\n   → If gate PASS: show Summary Mode, emit ASK_START\n   → If gate FAIL: show Chat Mode (suggestions), wait for user\n   ↓\n10. User confirms/overrides component type\n    ↓\n11. Main: handleUserSetComponentType()\n    → Update finalComponentType\n    → Send CLASSIFICATION_UPDATED\n    ↓\n12. UI: handleClassificationUpdated()\n    → Update reasoning to match finalComponentType\n    → Switch to Summary Mode\n    → Show \"Accessible it\" button\n```\n\n### Key Functions\n\n**Main Thread (`src/code.ts`)**:\n- `classifyComponent(node, dsContext)`: Orchestrator - runs all detectors, applies context bias, selects best candidate\n- `classifyTextFieldFromNodeTree(node)`: Text Field detector (structure + layout + semantic scoring)\n- `classifyButtonFromNodeTree(node)`: Button detector\n- `classifyCheckboxFromNodeTree(node)`: Checkbox detector (with negative gates)\n- `classifyFromImageVision(bytesBase64, nodeContext, dsContext)`: AI Vision classifier\n- `detectDesignSystemContext()`: Reads file/page names, returns `{ isDS, pageDomain, reasons }`\n- `handleVisionClassify()`: Main classification handler (AI + local fusion)\n\n**UI Thread (`ui/ui.html`)**:\n- `renderShell()`: Single UI shell renderer (manages all states)\n- `handleVisionClassifyResult()`: Updates UI based on classification result\n- `handleClassificationUpdated()`: Updates UI after user override\n\n---\n\n## 4. State Machine & UI Shell Rule\n\n### State Machine\n\nThe UI uses a single state machine (no \"two screens\"):\n\n```typescript\nconst state = {\n  // Selection state\n  selectionState: \"none\" | \"hasSelection\",\n  selectedNode: SceneNode | null,\n  selectionFingerprint: string | null,\n\n  // Classification state\n  classifyState: \"idle\" | \"processing\" | \"done\",\n\n  // Certainty state\n  certaintyState: \"certain\" | \"uncertain\",\n\n  // Reasoning state\n  reasoningState: \"collapsed\" | \"expanded\",\n\n  // Component type (separate suggested vs final)\n  suggestedComponentType: string | null,\n  finalComponentType: string | null, // After user override\n};\n```\n\n### UI Shell Rule\n\n**Always the same layout**:\n- Top bar (header with logo, buttons)\n- Identification card (component name, preview, type chip)\n- Validation section (intent, confidence)\n- Details section (reasoning toggle + panel)\n- Actions (Accessible it, Annotate buttons)\n\n**Uncertainty behavior**:\n- If `certaintyState === \"uncertain\"`: Add \"Suggestions / Correction Flow\" section at bottom\n- Do NOT replace entire screen with chat\n- Do NOT hide Summary Mode\n- Suggestions section contains: chips (sorted by confidence) + manual input + \"Start over\"\n\n**Reasoning correctness**:\n- Always use `finalComponentType` (after user override) for reasoning title/content\n- Never show \"Why Button\" if user selected \"Text Field\"\n\n---\n\n## 5. Classifier/Engine Output Contract\n\n### JSON Schema\n\n**`VISION_CLASSIFY_RESULT` message**:\n\n```typescript\n{\n  type: \"VISION_CLASSIFY_RESULT\",\n  nodeId: string,\n  suggestedComponentType: \"textField\" | \"dropdown\" | \"button\" | \"checkbox\" | \"unknown\",\n  componentTypeConfidence: number, // 0..1\n  intent?: \"password\" | \"email\" | \"phone\" | \"search\" | \"name\" | \"address\" | \"zip\" | \"url\" | \"username\" | \"description\" | \"other\" | \"unknown\",\n  intentConfidence?: number, // 0..1\n  suggestedLabel?: string,\n  reasoning: string[], // Bullet strings for \"Why {componentType}\"\n  intentReasoning?: string[], // Bullet strings for \"Why Intent\"\n  gate: \"PASS\" | \"FAIL\",\n  thresholds: { pass: number }, // Echo threshold used (0.90)\n  method?: \"local\" | \"ai_vision\" | \"fallback\",\n  nodeName?: string,\n  reasoningDataContext?: string, // File/page context\n}\n```\n\n### Gate Rules\n\n**PASS** (auto-proceed):\n- `componentTypeConfidence >= 0.90` AND\n- `componentType !== \"unknown\"` AND\n- (For Text Field) `structureScore >= 0.35`\n\n**FAIL** (ask user):\n- `componentTypeConfidence < 0.90` OR\n- `componentType === \"unknown\"` OR\n- (For Text Field) `structureScore < 0.35`\n\n### Decision Fusion Logic\n\n1. **AI Vision** (if enabled and API key available):\n   - Call `classifyFromImageVision()`\n   - If `componentType !== \"unknown\"` AND `componentTypeConfidence >= 0.80` → use AI\n   - If AI intent: `intentConfidence >= 0.75` → use AI intent\n\n2. **Local Classifier** (fallback or if AI fails):\n   - Call `classifyComponent()` (orchestrator)\n   - Runs all detectors, applies context bias, selects best candidate\n   - Returns `componentType`, `confidence`, `reasoning[]`\n\n3. **Auto-Resolve** (if FAIL):\n   - Climb parent tree (up to 3 levels)\n   - Re-run classification on parent\n   - If parent PASS → return parent result with \"Auto-resolved\" in reasoning\n\n### Example Outputs\n\n**PASS Example**:\n```json\n{\n  \"type\": \"VISION_CLASSIFY_RESULT\",\n  \"nodeId\": \"123:456\",\n  \"suggestedComponentType\": \"textField\",\n  \"componentTypeConfidence\": 0.92,\n  \"intent\": \"search\",\n  \"intentConfidence\": 0.78,\n  \"reasoning\": [\n    \"Container with visible fill/stroke\",\n    \"Text node inside container bounds\",\n    \"Left padding >= 8px\",\n    \"Single-line text structure\"\n  ],\n  \"intentReasoning\": [\n    \"Search icon detected\",\n    \"Nearby text: 'חיפוש'\"\n  ],\n  \"gate\": \"PASS\",\n  \"thresholds\": { \"pass\": 0.90 },\n  \"method\": \"ai_vision\",\n  \"nodeName\": \"Search Input\"\n}\n```\n\n**FAIL Example**:\n```json\n{\n  \"type\": \"VISION_CLASSIFY_RESULT\",\n  \"nodeId\": \"123:456\",\n  \"suggestedComponentType\": \"unknown\",\n  \"componentTypeConfidence\": 0.65,\n  \"reasoning\": [\n    \"Ambiguous structure\",\n    \"No clear input container pattern\"\n  ],\n  \"gate\": \"FAIL\",\n  \"thresholds\": { \"pass\": 0.90 },\n  \"method\": \"local\",\n  \"nodeName\": \"Component 1\"\n}\n```\n\n---\n\n## 6. How to Run / Build / Deploy\n\n### Build\n\n```bash\nnpm run build\n```\n\nThis runs:\n1. `build-ui`: Copies `ui/ui.html` to `dist/ui.html`, generates `src/ui-inline.ts`\n2. `build-main`: Compiles `src/code.ts` to `dist/src/code.js` (esbuild)\n3. `typecheck`: TypeScript type checking (no emit)\n\n### Development\n\n```bash\n# Watch UI changes\nnpm run dev:ui\n\n# Build only\nnpm run build-ui\nnpm run build-main\n```\n\n### Testing in Figma\n\n1. Open Figma Desktop\n2. Plugins → Development → Import plugin from manifest\n3. Select `manifest.json` from project root\n4. Plugin appears in Plugins menu\n5. Run plugin, select a node, click \"Accessible it\"\n\n### Deployment\n\n**Not yet implemented** - MVP is local development only.\n\n**Future**: Deploy to Figma Community (requires plugin approval process).\n\n---\n\n## 7. Definition of Done Summary\n\n**Source**: `Definition_Of_Done.md`\n\n### Build & Runtime\n- ✅ `npm run build` completes successfully\n- ✅ Plugin loads in Figma Desktop without errors\n- ✅ No unsupported JavaScript features in compiled output\n- ✅ `figma.showUI` receives valid HTML\n\n### MVP: Text Field E2E (Current Focus)\n\n**Selection → Preview**:\n- ✅ Preview exports as PNG at natural size (no upscale)\n- ✅ Transparent background\n- ✅ Preview renders correctly in UI\n\n**Component Detection**:\n- ✅ Multi-signal classification runs\n- ✅ Confidence gate: `confidence >= 0.90 AND structureScore >= 0.35`\n- ✅ Auto-resolve: climb parent tree up to 3 levels if FAIL\n- ✅ Returns `componentType: \"textField\"` or `\"unknown\"`\n\n**ASK Flow**:\n- ✅ If PASS: auto-filled, user can review/adjust\n- ✅ If FAIL: manual chips + input\n- ✅ `ASK_START` message sent with `source: \"auto\"` or `\"manual\"`\n\n**Scan Rules** (TF-01..TF-14):\n- ❌ **NOT IMPLEMENTED** - Placeholder only\n\n**Autofix**:\n- ❌ **NOT IMPLEMENTED** - Placeholder only\n\n**Handoff**:\n- ❌ **NOT IMPLEMENTED** - Placeholder only\n\n### Error Handling\n- ✅ Runtime errors surfaced to UI\n- ✅ User always gets feedback\n- ✅ No silent failures\n\n### UI Accessibility\n- ✅ Status updates via `aria-live`\n- ✅ Icon-only buttons have accessible names\n- ✅ Keyboard navigation works\n\n### Designer Experience\n- ✅ Plugin doesn't modify layout unexpectedly\n- ✅ Risky fixes are suggestions only\n- ✅ User understands what changed and why\n\n---\n\n## 8. Open TODOs (Finish MVP)\n\n### Critical (Block MVP Completion)\n\n1. **Scan Rules Implementation** (`src/code.ts`)\n   - Implement TF-01..TF-14 checks for Text Field\n   - All checks return WARN (no FAIL)\n   - Stream results to UI (`SCAN_PROGRESS` messages)\n   - Reference: `docs/03-components/mvp-rule-pack.docx`\n\n2. **Autofix Engine v1** (`src/code.ts`)\n   - Safe autofix (default ON):\n     - Rename layers (Input / Label / Helper / Icon / Container)\n     - Enforce min font sizes (body min 14, headings/labels 16) - WARN + suggestion only\n     - Create Focus state variant when missing\n     - Add annotation metadata (plugin data)\n   - Reference: `docs/01-foundations/foundations-engine-logic.docx`\n\n3. **Handoff Generator** (`src/code.ts`)\n   - Design guidance (what to change in design)\n   - UX patterns (states, focus, error patterns)\n   - Code snippets (HTML/ARIA)\n   - Reference: `docs/03-components/mvp-rule-pack.docx`\n\n4. **ASK Flow Completion** (`src/code.ts`, `ui/ui.html`)\n   - Scan-level ASK (not just component type)\n   - Template-based questions\n   - User responses stored and applied\n\n### High Priority (Before Launch)\n\n5. **Button/Checkbox/Dropdown Detectors Refinement**\n   - Improve confidence scoring\n   - Add negative gates (like checkbox has)\n   - Test on Design System pages\n\n6. **Test Scenarios Execution**\n   - Run all tests in `docs/02-project/test-scenarios.md`\n   - Document results\n   - Fix any failures\n\n7. **UI Polish**\n   - Preview zoom/pan bounds clamping (408x408)\n   - Theme toggle persistence\n   - Animation smoothness\n\n### Medium Priority (Post-MVP)\n\n8. **Post-MVP Components**\n   - Radio, Toggle/Switch, Link, Icon Button, Textarea, Search, Password, Date picker, Modal/Dialog, Toast/Alert\n   - Reference: `docs/02-project/Project-plan.md` section 10.2\n\n9. **Deployment**\n   - Figma Community submission\n   - Plugin store listing\n   - Documentation site\n\n---\n\n## 9. Key Documents Reference\n\n### Source of Truth (Locked)\n- `docs/01-foundations/foundations-engine-logic.docx`: Engine logic, AI Visual First, gates, schema\n- `docs/03-components/mvp-rule-pack.docx`: MVP component rules, checks, autofix boundaries, handoff\n\n### Master Plan\n- `docs/02-project/Project-plan.md`: Complete project plan, locked decisions, workstreams\n\n### Supporting Docs\n- `docs/02-project/test-scenarios.md`: Acceptance tests (15 test cases)\n- `docs/04-research/classifier-orchestrator-research.md`: Classifier architecture details\n- `docs/04-research/Runtime Accessibility Intent Catalog.md`: Runtime intents (filtered to MVP)\n- `docs/04-research/Design-Time Signals – Raw Extraction.md`: Signal extraction details\n\n### Code\n- `src/code.ts`: Main thread (classification, message handling)\n- `src/protocol.ts`: Message types and guards\n- `ui/ui.html`: UI thread (state machine, rendering)\n\n---\n\n## 10. Quick Reference: Locked Decisions\n\n| Decision | Value | Source |\n|----------|-------|--------|\n| AI Visual First | Default ON | Project-plan.md §5.1 |\n| Confidence Gate | 0.90 (strict) | Project-plan.md §5.3 |\n| Severity Policy | PASS/ASK/WARN only (no FAIL) | Project-plan.md §7 |\n| UI Shell | Static layout, uncertainty adds suggestions | Project-plan.md §10.4.1 |\n| Output Schema | Unified JSON contract | Project-plan.md §11.1 |\n| MVP Components | Text Field, Button, Checkbox, Dropdown | Project-plan.md §10.1 |\n\n---\n\n## 11. Common Questions\n\n**Q: Why is AI Vision default ON but sometimes uses local classifier?**  \nA: AI Vision requires OpenAI API key. If missing or API call fails, falls back to local classifier automatically.\n\n**Q: What's the difference between `suggestedComponentType` and `finalComponentType`?**  \nA: `suggestedComponentType` is what the classifier detected. `finalComponentType` is after user override (if any). Reasoning always uses `finalComponentType`.\n\n**Q: Why does DS context exclude certain component types?**  \nA: Design System pages have strong context signals. A \"Buttons\" page should never classify as Checkbox, even with weak icon signals. Hard-gating prevents misclassification.\n\n**Q: What happens if classification fails on selected node?**  \nA: Auto-resolve climbs parent tree (up to 3 levels) and re-runs classification. If parent passes gate, returns parent result with \"Auto-resolved\" in reasoning.\n\n**Q: How do I add a new component type?**  \nA: 1) Add detector function (e.g., `classifyRadioFromNodeTree()`), 2) Add to orchestrator in `classifyComponent()`, 3) Update protocol types, 4) Add to MVP rule pack.\n\n---\n\n## Immediate Execution Phase\n\n- [ ] Create Logic Rules for Text Field (TF-01 to TF-14).\n- [ ] Create Logic Rules for Button (BL-01 to BL-05).\n- [ ] Hook Logic into Orchestrator (src/code.ts).\n",
  "currentStatus": "# Current Rules Status\n\n**Last Updated**: 2025-12-29  \n**Purpose**: Track which rules are implemented vs pending\n\n---\n\n## Text Field Rules\n\n- TF-01: Type Detection ✅ Implemented\n- TF-02: Field Label ✅ Implemented\n- TF-03: Field Required ✅ Implemented\n- TF-04: Field Validation Focus ✅ Implemented\n- TF-05: Field Validations ✅ Implemented\n- TF-06: Field Context ✅ Implemented\n- TF-07: Field Placeholder ✅ Implemented\n- TF-08: Field Error Messages ✅ Implemented\n- TF-09: Field Help Text ✅ Implemented\n- TF-10: Field Keyboard Navigation ✅ Implemented\n- TF-11: Field Auto-complete ✅ Implemented\n- TF-12: Field Input Types ✅ Implemented\n- TF-13: Field Size Constraints ✅ Implemented\n- TF-14: Field Color Contrast ✅ Implemented\n\n**Total**: 14/14 implemented (100%)\n\n---\n\n## Button Rules\n\n- BL-01: Button Roles ✅ Implemented\n- BL-02: Button Labeling ✅ Implemented\n- BL-03: Button States ✅ Implemented\n- BL-04: Button Keyboard Navigation ✅ Implemented\n- BL-05: Button Focus Indicators ✅ Implemented\n\n**Total**: 5/5 implemented (100%)\n\n---\n\n## Checkbox Rules\n\n- CB-01: Checkbox Roles ✅ Implemented\n- CB-02: Checkbox Labeling ✅ Implemented\n- CB-03: Checkbox States ✅ Implemented\n\n**Total**: 3/3 implemented (100%)\n\n---\n\n## Select/Dropdown Rules\n\n- SC-01: Select Roles ✅ Implemented\n- SC-02: Select Labeling ✅ Implemented\n- SC-03: Select Keyboard Navigation ✅ Implemented\n\n**Total**: 3/3 implemented (100%)\n\n---\n\n## Overall Status\n\n**Total Rules**: 25  \n**Implemented**: 25  \n**Pending**: 0  \n**Coverage**: 100%\n\n---\n\n## Notes\n\n- All MVP rules (TF-01..TF-14, BL-01..BL-05, CB-01..CB-03, SC-01..SC-03) are fully implemented in `src/rules/`\n- Rules are wired into the orchestrator in `src/code.ts` via `classifyComponent`\n- All rules return WARN/ASK only (no FAIL/BLOCKER per MVP policy)\n- Evidence: `src/rules/textField.ts`, `src/rules/button.ts`, `src/rules/checkbox.ts`, `src/rules/dropdown.ts`\n",
  "truth": {
    "note": "Source of truth: Foundations + MVP rule pack. שאר המסמכים תומכים בלבד.",
    "docs": [
      {
        "label": "Foundations – engine logic",
        "path": "docs/foundations-engine-logic-LOCKED.docx"
      },
      {
        "label": "MVP rule pack",
        "path": "docs/mvp-rule-pack-LOCKED.docx"
      }
    ]
  },
  "pipeline": [
    {
      "id": "select",
      "title": "בחירה",
      "detail": "המעצב בוחר נוד ב-Figma"
    },
    {
      "id": "preview",
      "title": "תצוגה מקדימה",
      "detail": "PNG בגודל טבעי עם רקע שקוף"
    },
    {
      "id": "type",
      "title": "זיהוי סוג קומפוננטה",
      "detail": "חוקים מקומיים עם Gate קשיח"
    },
    {
      "id": "intent",
      "title": "Intent/Label",
      "detail": "ברירת מחדל: Unknown. Auto-resolve עד 3 הורים"
    },
    {
      "id": "checks",
      "title": "בדיקות",
      "detail": "TF-01…TF-14 (WARN בלבד ב-MVP)"
    },
    {
      "id": "fix",
      "title": "אוטו-פיקס",
      "detail": "רק Safe autofixes לפי קריטריונים"
    },
    {
      "id": "handoff",
      "title": "Handoff",
      "detail": "פלט מובנה לדיזיין + Dev"
    }
  ],
  "gates": {
    "local": {
      "confidence": 0.85,
      "structural": 0.35
    },
    "vision": {
      "enabledByDefault": false,
      "role": "Boost + sanity check (לא dependency)"
    }
  },
  "build": {
    "command": "npm run build",
    "artifacts": [
      {
        "path": "dist/src/code.js",
        "note": "Main plugin bundle"
      },
      {
        "path": "dist/ui.html",
        "note": "UI bundle"
      },
      {
        "path": "src/ui-inline.ts",
        "note": "Generated – לא לערוך"
      }
    ]
  },
  "storage": [
    {
      "key": "aims.log",
      "type": "Array<JobLog>",
      "purpose": "היסטוריית הרצות (UNDO)"
    },
    {
      "key": "ams-settings",
      "type": "Settings",
      "purpose": "העדפות משתמש (provider/model/keys)"
    },
    {
      "key": "OPENAI_API_KEY",
      "type": "string",
      "purpose": "מפתח AI Vision"
    }
  ],
  "files": {
    "mustEdit": [
      {
        "path": "src/code.ts",
        "why": "לוגיקה: orchestrator + detectors + gates"
      },
      {
        "path": "ui/ui.html",
        "why": "UI + state machine"
      },
      {
        "path": "src/protocol.ts",
        "why": "פרוטוקול הודעות"
      }
    ],
    "dontEdit": [
      {
        "path": "src/ui-inline.ts",
        "why": "Generated"
      },
      {
        "path": "dist/*",
        "why": "Build output"
      }
    ]
  },
  "projectTree": {
    "groups": [
      {
        "title": "Must-edit (MVP)",
        "nodes": [
          {
            "path": "src/code.ts",
            "tags": [
              "logic",
              "orchestrator",
              "detectors"
            ]
          },
          {
            "path": "ui/ui.html",
            "tags": [
              "ui",
              "state-machine"
            ]
          },
          {
            "path": "src/protocol.ts",
            "tags": [
              "protocol"
            ]
          }
        ]
      },
      {
        "title": "Generated (do not edit)",
        "nodes": [
          {
            "path": "src/ui-inline.ts",
            "tags": [
              "generated"
            ]
          },
          {
            "path": "dist/src/code.js",
            "tags": [
              "compiled"
            ]
          },
          {
            "path": "dist/ui.html",
            "tags": [
              "copied"
            ]
          }
        ]
      },
      {
        "title": "Docs",
        "nodes": [
          {
            "path": "docs/foundations-engine-logic-LOCKED.docx",
            "tags": [
              "authoritative"
            ]
          },
          {
            "path": "docs/mvp-rule-pack-LOCKED.docx",
            "tags": [
              "authoritative"
            ]
          },
          {
            "path": "README.md",
            "tags": [
              "supporting"
            ]
          },
          {
            "path": "ARCHITECTURE.md",
            "tags": [
              "supporting"
            ]
          }
        ]
      }
    ]
  },
  "ideas": {
    "src/code.ts": [
      "DS-context hard block: בעמוד Buttons לא לסווג כ-Text Field בלי ראיות חזקות.",
      "Cross-check בין Vision לבין local: אם Vision בטוח אבל structural נמוך – לעבור ל-Ask.",
      "Reasoning trace טיפוסי לכל סיווג (debug drawer ב-UI)."
    ],
    "ui/ui.html": [
      "Ambiguity resolution: במקום dropdown – 2–4 כפתורי בחירה inline.",
      "תצוגה מקדימה גדולה עד אחרי אישור (לא לכווץ לפני).",
      "Status timeline קומפקטי: סריקה → סיגנלים → Gate → בדיקות → handoff."
    ],
    "src/protocol.ts": [
      "JOB_UPDATE אחיד עם payload מובנה (stage/progress/trace/preview).",
      "Protocol versioning כדי למנוע אי-תאימות UI/Main בזמן איטרציות."
    ],
    "Build/Deploy": [
      "build:watch שמדפיס מה השתנה (UI/Main).",
      "deploy sanity: אימות path של manifest ל-dist/."
    ]
  }
}